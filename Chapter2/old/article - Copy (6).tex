\documentclass[article]{jss}

\usepackage{bm}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage{lscape}
%\numberwithin{equation}{section}
%\numberwithin{figure}{section}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% declarations for jss.cls %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\author{Kevin C. Chang\\University of Auckland,\\ New Zealand \And
        Richard G. Jarrett\\CSIRO, Adelaide,\\ Australia \And
        Chris M. Triggs\\University of Auckland,\\ New Zealand \And
        Katya Ruggiero\\University of Auckland,\\ New Zealand }
\title{\pkg{InfoDecompuTE}: an \proglang{R} package for information decomposition of two-phase experiments }

%% for pretty printing and a nice hypersummary also set:
\Plainauthor{Kevin C. Chang, Richard G. Jarrett, Chris M. Triggs, Katya Ruggiero} %% comma-separated
\Plaintitle{InfoDecompuTE: an R package for information decomposition of two-phase experiments} %% without formatting
\Shorttitle{{\small\pkg{InfoDecompuTE}: an \proglang{R} package for information decomposition of two-phase experiments}} %% a short title (if necessary)

%% an abstract and keywords
\Abstract{Studies in which an experimental unit's response to treatment cannot be measured directly are said to be two-phase.  In such cases, material harvested from the experimental units requires further processing in a subsequent experiment before measurements can be made. Consequently, each experimental phase introduces different sources of variation and how these interact with one another depends on the experimental designs between the phases.

To assess the properties of competing designs for two-phase experiments, it is necessary to examine their theoretical ANOVA tables, which can be a very time-consuming exercise to perform manually. We will introduce our very flexible R package, \pkg{infoDecompuTE}, which for a given single- or two-phase experiment will quickly construct the ANOVA table, showing any existing strata, expected mean squares for all sources of variation and average efficiency factors, as appropriate.
}
\Keywords{two-phase experiments, experimental design, analysis of variance, \pkg{InfoDecompuTE}}
\Plainkeywords{keywords, comma-separated, not capitalized, InfoDecompuTE} %% without 
%% publication information
%% NOTE: Typically, this can be left commented and will be filled out by the technical editor
%% \Volume{13}
%% \Issue{9}
%% \Month{September}
%% \Year{2004}
%% \Submitdate{2004-09-29}
%% \Acceptdate{2004-09-29}
\Address{
  Kevin C. Chang\\
  Bioinformatics Institute \\
  School of Biological Sciences\\
  The University of Auckland\\
  New Zealand\\
  E-mail: \email{kcha193@aucklanduni.ac.nz}\\
  \today\\
}

%% It is also possible to add a telephone and fax number
%% before the e-mail in the following format:
%% Telephone: +43/1/31336-5053
%% Fax: +43/1/31336-734

%% for those who use Sweave please include the following line (with % symbols):
%% need no \usepackage{Sweave.sty}

%% end of declarations %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{document}
\section[Introduction]{Introduction}
A primary objective of comparative experiments is to contrast measurements made on experimental units of material (e.g.\ humans, animals, plants, tissues, cells, etc.) in response to the interventions, or \emph{treatments}, applied to them. Many situations arise in practice in which the response variable of interest cannot be measured directly from the experimental units in a single experiment (Phase 1). Instead, they must be further processed in a subsequent experiment (Phase 2) for the measurements to be made. Such  \emph{two-phase experiments} were introduced by \cite{McIntyre1955} in the context of a study investigating the effects of four light treatments on the synthesis of tobacco mosaic virus in the leaves of tobacco plants. Healthy tobacco plants were inoculated with the virus and subjected to different light treatments (Phase 1 experiment). To measure the severity of the disease, sap was first expressed from the experimental tobacco plants and then injected into the leaves of specific assay plants (Phase 2 experiment) on which lesions subsequently appeared and were counted. Each experimental phase introduce different sources of variation, e.g. biological variation from the tobacco plants at the Phase 1 and from the assay plants at the Phase 2. In particular, the sources of variation from the Phase 2 experiment has shown to interact with the sources of variation introduced at the Phase 1. Hence, it is important to consider the sources of variation that are introduced at each phase when designing two-phase experiments.

Another example of where two-phase experiment arise are two-colour microarray experiments \citep{Jarrett2008}. They studied the effect of using different designs in the Phase 2 experiment, while using an identical Phase 1 experimental design. The designs studied in the Phase 2 experiment were multiple dye-swap and alternating loop designs \citep{Churchill2002}. The multiple dye-swap design is where on one array sample 1 and sample 2 are assigned to red and green dyes, respectively. Then, one the second array, the dye assignments are reversed. The alternating loop designs is where the samples are compared to one to another in a daisy-chain fashion \citep{Churchill2002}. These designs can be considered as \emph{competing designs}, because the same numbers of dyes and arrays are used for both designs. The comparison is made by constructing a theoretical analysis of variance (ANOVA) table. The main purpose of ANOVA is to subdivide the total variability between the observations from the experiment into different sources of variation. This procedure of separating the total variability into different sources of variation is also know as \emph{information decomposition}. The traditional ANOVA table consists of the degrees of freedom (DF) and the mean squares (MS) for each of these sources of variation. The theoretical ANOVA table also provides the \emph{expected mean square} (EMS), which consists of the linear combination of the variance components. The EMS is useful in determining whether a \emph{valid} F-test is present if the EMS of the residual equals to the EMS of the treatment excluding the non-centrality parameter. 

Efforts have been made towards developing a general theory for the design of two-phase experiments \citep{Brien1983, Wood1988, Brien1999, Jarrett2008}, with substantial progress being made in recent years by \cite{Brien2006b, Brien2009, Brien2010}. The two-phase experiments are generally made up of two phases of allocation: the allocation of treatment factors to the block factors in the Phase 1 experiment and the allocation of the block factors in the Phase 1 experiment to the block factors in the Phase 2 experiment. Hence, the randomisation procedure generally needs to be preformed twice for each of these two allocations. \cite{Brien2006b} named the randomisation procedure for the two-phase experiments as \emph{multiple randomisation} and they compared and contrasted six different types multiple randomisation procedures for the different situations of the two-phase experiments. The decomposition of the data space for different multiple randomisation procedures are then discussed by \cite{Brien2009, Brien2010}. \cite{Brien2011} explained the theories to date in simpler terms with some fundamentals in designing two-phase experiments. In addition,  \cite{Brien2011} provided a set of basic rules for deriving the EMS; but these rules applied manually and only for the balanced design.  

The construction of ANOVA tables can be laborious when performed manually for small two-phase experiments. Unfortunately there is currently no statistical software capable of computing the EMS for two-phase experiments directly. ANOVA for generally balanced designs can be constructed using pseudofactors in \proglang{Genstat}, however, this approach provides only the decomposition of degrees of freedom. The \code{AMTIER} procedure within \proglang{Genstat} can also produce the structure of an ANOVA with the decomposition of DF, but it does not gives the EMS \citep{Brien2006a}. The \code{GLM} procedures in \proglang{JMP} and \proglang{SAS}, and \code{ANOVA} command in \proglang{Minitab}, have the ability to compute the EMS, but neither program can easily cope with two-phase experiments. The \proglang{R} package \pkg{dae}, developed by \cite{Brien2011a}, has the ability to perform information decomposition of a given design. However, this package cannot directly complete an overall decomposition of an experiment and generate the theoretical ANOVA table.

We introduce an \proglang{R} package called \pkg{infoDecompuTE}, for the {\bf info}rmation {\bf decomp}osition of {\bf T}wo-phase {\bf E}xperiments. It is capable of quickly generating the theoretical ANOVA table corresponding to any given single- or two-phase design, by showing how the known sources of variation in the experiment are distributed across different strata and thereby enabling the researchers to compare the properties of competing designs. As a direct consequence, one can quickly assess whether a particular design leads to a valid F-test.

In this article, we demonstrate the concepts and the methods underlying \pkg{infoDecompuTE} as well as its use. Section~\ref{sec:infoDecomp} explains the information decomposition for a single-phase experiment. Section~\ref{sec:infoiDecompTwoPase} discusses the information decomposition for the two-phase experiments and how it is different to the single-phase experiment. Section~\ref{sec:exampleTwoPase} shows an example of two-phase experiments with the theoretical ANOVA tables. Section~\ref{sec:package} demonstrates the usage of R package \pkg{infoDecompuTE}. Finally, section~\ref{sec:example} illustrates how the use of package with a published two-phase viticulture-sensory evaluation experiment by \cite{Brien1999}.

\section{Information decomposition of designed experiments} 
\label{sec:infoDecomp}
The design of an experiment and the linear model which describes the design are intimately linked. More specifically, the linear model describes the relationships between the experimental units, or \emph{block structure}, between the treatments, or \emph{treatment structure}, and the assignment of the treatments to the experimental units. For example, consider a randomized complete block design (RCBD) in which the term \emph{block} refers to any group of experimental units that share a set of characteristics \citep{Bailey2008}.
 
In the following, an arbitrary design is considered involving both block and treatment factors whose relationships can be represented mathematically by a linear \emph{mixed-effects model}. We will show how the raw data from such an experiment is decomposed into its constituent components based on its block and treatment structures.

\subsection{The linear mixed-effects model}
\label{subsec:matrixLMM}
The linear mixed-effects model in matrix notation can be written as
\begin{equation}\label{eq:matrixLMM}
\bm{y} = \bm{1}\mu + X\bm{\alpha} + Z\bm{\beta} + \bm{\epsilon},
\end{equation}
where $\bm{y}$ is an $n \times 1$ vector of responses, $\bm{1}$ is an $n \times 1$ vector with all elements unity, $\mu$ denotes the grand mean of the data, and $\bm{\epsilon}\sim \mathcal{N}(0,\sigma^2)$ is a $n \times 1$ vector of unobserved random experimental errors. 

For the experiment consists of $B$ block factors, a vector of block parameters, $\bm{\beta}$, consists of a set of vectors for block parameters and can be written as
\begin{equation}\label{eq:block1Par}
\bm{\beta} = (\bm{\beta}_1; \bm{\beta}_2; \dots; \bm{\beta}_B), 
\end{equation} 
where $\bm{\beta}_i ~ \sim N(0, \sigma_i^2)$ denote the $i$th vector of block parameter with length of $b_i$. Hence, all of these $\bm{\beta}_i$ should be bold and can be expressed as 
\[
\bm{\beta}_i = (\beta_{i1}, \beta_{i1}, \dots, \beta_{i b_i}).
\] 

The block design matrix, $Z$ in (\ref{eq:matrixLMM}), can be expressed as 
\begin{equation}\label{eq:block1Mat}
Z = [Z_1 \vert Z_2 \vert \ldots \vert Z_B ]
\end{equation}
where $Z_i$ is the design matrix corresponding to the $i$th block factor within $\bm{\beta}$. Thus, the dimension of $Z$ consists of $n$ rows and the number of column is the sum of the length of each vector within $\bm{\beta}$, i.e.\
\[
\sum^{B}_{i = 1} b_i.
\]

The last two remaining terms in (\ref{eq:matrixLMM}) are $\bm{\alpha}$ and $X$ which are the vector of treatment parameters and matrix for the treatment design, respectively. For the $N$-factor factorial experiment, if the treatment factor $i$ consists of $v_i$ level, then the vector of treatment parameter, denoted by $\bm{\alpha}$, consists of 
\begin{equation}
\label{eq:treatPar}
\bm{\alpha} = (\alpha_{11 \dots 1}, \alpha_{11 \dots 2}, \dots,  \alpha_{1v_2 \dots v_N},\dots,\alpha_{v_1 v_2 \dots v_N}),
\end{equation}
where each $\alpha$ has $N$ number of indexes corresponding to $N$-factor. Note that $\alpha$ is not bold, because it is not a vector like the block parameter. Each $\alpha$ denotes the effects from a specific treatment factorial combination.

The treatment design matrix, $X$ in (\ref{eq:matrixLMM}), corresponding to the $\bm{\alpha}$. Thus, the dimension of $X$ consists of $n$ rows and the number of column is the product of the levels from all treatment factors, i.e.\
\[
\prod^{N}_{i = 1} v_i.
\]

In summary, this subsection presents a general linear mixed-effect model for a designed experiment. The number of block factors will change the number of vectors of block parameter in $\bm{\beta}$ and the number of block design sub-matrices within $Z$. However, the number of treatment factors can affect in the indexes for the $\alpha$ in $\bm{\alpha}$. The treatment design matrix is then constructed based on the combination of the treatment parameters. The structure of design matrices are essential in describing the the decomposition methods which are shown in the remaining of this section.  
 
\subsection{Null decomposition using projection matrices}
\label{subsec:strataDecompProj}
The vector of response, $\bm{y}$, in (\ref{eq:matrixLMM}) spans an $n$-dimensional Euclidean space, commonly denoted by $\mathbb{R}^n$. A vector space, $\mathbb{V}$, is a \emph{subspace} of $\mathbb{R}^n$, i.e.\ $\mathbb{V} \subset \mathbb{R}^n$, if every vector in $\mathbb{V}$ is also in $\mathbb{R}^n$ \citep{Hadi1996}. 

The information decomposition of $\bm{y}$ is its separation from $\mathbb{R}^n$ space into its constituent vector subspace components. These vector subspaces can be referred to as the \emph{strata} of the ANOVA and can be mathematically expressed as 
\begin{equation}
\label{eq:vecSpace}
\mathbb{R}^n = \mathbb{V}_0 \oplus \mathbb{V}_1 \oplus, \dots , \oplus \mathbb{V}_{B},
\end{equation} 
where $\oplus$ denotes addition operator of the vector spaces, $\mathbb{V}_i$ denotes the stratum that corresponds to the $i$th block parameters and block design sub-matrices defined in (\ref{eq:block1Par}) and (\ref{eq:block1Mat}), respectively. Note the first element in (\ref{eq:vecSpace}), $\mathbb{V}_0$, denotes the grand mean vector subspace.  

Since the decomposition is the separation of the known variation in the data, the variance structure of the data, $\bm{y}$, can be expressed in a spectral form as
\begin{equation}
\label{eq:strata}
\operatorname{Var}(\bm{y}) = \sum_{i=0}^{B} \xi_i Q_i,
\end{equation}
where $Q_i$ is an $n \times n$ idempotent matrix and is, therefore, the \emph{orthogonal projector} of $\bm{y}$ onto the vector subspace  $\mathbb{V}_i$ (i.e.\ stratum $i$) and $\xi_i$ is the $i$th stratum variance (i.e.\ $\xi_i = \operatorname{Var}(Q_i y)$).

The matrix $Q_i$ can also be shown in the decomposition of the total SS, $\bm{y}'\bm{y}$, into $B$ components of the SS, i.e.\ 
\begin{equation}
\label{eq:decomp}
\bm{y}'\bm{y} = \sum_{i=0}^{B}\bm{y}'Q_i\bm{y},
\end{equation}
where $\bm{y}'Q_i\bm{y}$ denotes the SS of the $i$th stratum. Hence, Equations~(\ref{eq:vecSpace}), (\ref{eq:strata}) and (\ref{eq:decomp}) give a basic illustration of decomposition ignoring the treatment, namely the \emph{null decomposition}. The process results from the sequential fitting of the block factors, computing the SS of each block factor and sweeping the computed SS from the total SS. The remainder of this section describes each step of null decomposition.

The initial step of null decomposition is to sweep the grand mean from raw data, $\bm{y}$. The $\mu$ is a vector of length $1$; thus, the grand mean vector spans in a $1$-dimensional grand mean vector subspace, denoted by $\mathbb{V}_0$. To sweep the grand mean from $\bm{y}$, $\bm{y}$ is first projected onto the grand mean vector subspace, i.e.\ $Q_{0}\bm{y}$.

The grand mean vector subspace can be represented by a $n \times n$ averaging matrix, denoted by $K_n$ or $K$, with all elements equal to ${n}^{-1}$. The orthogonal projector of $\mathbb{V}_0$ is then derived by
\begin{equation}
\label{eq:vectorProj}
Q_{0} = P_{K} = K(K'K)^{-1}K',
\end{equation}
where $P_K$ denotes the \emph{projection matrix} of matrix $K$. The projection matrix of any averaging matrix can be shown to be identical as the averaging matrix, i.e.\ 
\[Q_{0} \bm{y} = P_{K} \bm{y} = K \bm{y}.\] 

%The properties of projection matrices are symmetric (i.e. $P' = P$), orthogonal (i.e. $P_aP_b = 0$) and idempotent (i.e. $P^2 = PP = P$)  \citep{Hadi1996}. The projection matrix denote by $P$ should not be confused with the orthogonal projectors denote by $Q$. The projection matrices are calculated from the design matrices using (\ref{eq:vectorProj}) and are used to project the raw data onto different vector subspaces. On the other hand, the orthogonal projectors are the matrices for defining the strata and constructed by the projection matrices. Thus, they are not always the same but closely related. 

Next, subtract $\bm{y}$ by the grand mean vector, $K\bm{y}$, i.e.\
\[\bm{y} -  K\bm{y} = (I-K)\bm{y},\]
where $(I-K)\bm{y}$ denotes the \emph{mean corrected observational vector}. The $(I-K)\bm{y}$ spans in $\mathbb{V}^{\perp}_0$ with the dimension of $(n - 1)$. The $\mathbb{V}^{\perp}_0$ denotes the \emph{orthogonal complement} of $\mathbb{V}_0$. Furthermore, the adjusted total SS is obtained by pre-multiplying the $(I-K)\bm{y}$ by its transpose, i.e.\
\begin{equation}
\label{eq:adjustSS}
[(I - K)\bm{y}]'[(I - K)\bm{y}] = \bm{y}'(I-K)\bm{y}.
\end{equation}
The total adjusted SS can be calculated as
\[
\bm{y}'\bm{y} - \bm{y}'K\bm{y} = \bm{y}'(I-K)\bm{y},
\]
which is based on the \emph{Pythagoras' theorem}.

The $(I-K)\bm{y}$ is then projected onto the next vector subspace, $\mathbb{V}_1$, giving $Q_{1}\bm{y}$, where the $Q_{1}$ is the orthogonal projector of the stratum for the first block parameter. The vector subspace $\mathbb{V}_1$ is represented by the block design matrix, $Z_1$, and its projection matrix, $P_{Z_1}$ can be computed from 
\[Z_1(Z_1'Z_1)^{-1}Z_1'.\] 
To project $(I-K)\bm{y}$ onto $\mathbb{V}_1$, $(I-K)\bm{y}$ is pre-multiplying by $P_{Z_1}$ and can be expressed as
\begin{equation}\label{eq:projectB}
P_{Z_1}[(I - K)\bm{y}] = (P_{Z_1} - K)\bm{y} = Q_{1}\bm{y},
\end{equation}
where vector $(P_{Z_1} - K)\bm{y}$ corresponds to the effects of first block parameter, $\beta_1$. The orthogonal complement of $(P_{Z_1} - K)\bm{y}$ is derived by
\begin{equation}
\label{eq:orthComp}
(I - K)\bm{y}- (P_{Z_1} - K)\bm{y} = (I - P_{Z_1})\bm{y},
\end{equation}
which corresponds to the elimination on the effects of $\beta_1$. 

The SS are derived by pre-multiplying the vectors in (\ref{eq:projectB}) and (\ref{eq:orthComp}) by its transpose as described in (\ref{eq:adjustSS}), i.e.\ 
\[
\bm{y}'(I - K)\bm{y}- \bm{y}'(P_{Z_1} - K)\bm{y} = \bm{y}'(I - P_{Z_1})\bm{y}.
\]

If the block structure contains additional block factors, e.g.\ plots and/or subplots, the vector $(I - P_{Z_1})\bm{y}$ is further projected onto the next vector subspace, $\mathbb{V}_2$. In summary, to project the raw data vector, $\bm{y}$ from $\mathbb{V}_{i}$ onto $\mathbb{V}_{i + 1}$ can be written as $P_{Z_{i+1}}Q_{i}\bm{y}$. The orthogonal complement of $P_{Z_{i+1}}Q_{i}\bm{y}$ can be derived by subtraction, i.e.\
\begin{equation}
\label{eq:orthCompSummary}
Q_{i}\bm{y}- P_{Z_{i+1}}Q_{i}\bm{y} = (I -P_{Z_{i+1}})Q_{i}\bm{y} = Q_{i+ 1}\bm{y}.
\end{equation}
Thus, the SS are derived by pre-multiplying the vectors in (\ref{eq:orthCompSummary}) as 
\[
\bm{y}'Q_{i}\bm{y}- \bm{y}'Q_{i}P_{Z_{i+1}}Q_{i}\bm{y} = \bm{y}'Q_{i}(I -P_{Z_{i+1}})Q_{i}\bm{y}=\bm{y}'Q_{i+ 1}\bm{y}.
\]

%If within the block structure contains further additional block factors, e.g.\ plots and/or subplots, the Between or Within Blocks vectors has to be further decomposed by projecting these two vectors onto the additional block vector subspace, and computing their orthogonal complements. The ESS and EMS can then be calculated as described above.

Providing the SS for each stratum is defined using the orthogonal projectors, the EMS can then be computed for the theoretical ANOVA table. From (\ref{eq:decomp}), the expected sum of squares (ESS) of the $i$th stratum can be shown as
\begin{equation}
\label{eq:ESSQuad}
\operatorname{E}(\bm{y}'Q_i\bm{y})= \mathrm{tr}(Q_i\operatorname{cov}(\bm{y})) + \bm{\alpha} ' C_x X'Q_iX C_x\bm{\alpha},
\end{equation}
where $\operatorname{cov}(\bm{y})$ is the variance covariance matrix and $\mathrm{tr}(Q_i\operatorname{cov}(\bm{y}))$ is the \emph{trace} of the matrix obtained by $Q_i\operatorname{cov}(\bm{y})$ \citep{Searle1982}. The treatment component, denoted by $\bm{\alpha} '  C_x X'Q_iX C_x \bm{\alpha}$, is discussed later in the Section~\ref{subsec:estTrt}.

Consider an experiment arranged in RCBD, the null decomposition of the total SS can be expressed as 
\begin{equation}
\label{eq:infoDecomp1}
\bm{y}'\bm{y} = \bm{y}'K\bm{y} + \bm{y}'(P_{Z_B}-K)\bm{y} + \bm{y}'(I - P_{Z_B})\bm{y},
\end{equation}
where $K$, $(P_{Z_B}-K)$ and $(I - P_{Z_B})$ denote the orthogonal projectors of grand mean, Between and Within Blocks strata, i.e.\ , $\mathbb{V}_0$, $\mathbb{V}_1$ and $\mathbb{V}_2$, respectively. 

Since the SS of Between Blocks stratum is $\bm{y}'(P_{Z_B}-K)\bm{y}$, the ESS of Between Blocks stratum can then be shown as 
\begin{eqnarray}
\nonumber \operatorname{E}(\bm{y}'(P_{Z_B}-K)\bm{y}) &=& \mathrm{tr}[(P_{Z_B}-K)\operatorname{cov}(\bm{y})]\\
\nonumber &=& \mathrm{tr}[(P_{Z_B}-K)\operatorname{cov}(\bm{\epsilon})] + \mathrm{tr}[Z'(P_{Z_B}-K)Z\operatorname{cov}(\bm{\beta})]\\ 
\nonumber &=& (b - 1)\sigma^2 + (b - 1)v\sigma^2_B\\
\label{eq:computRBD} &=& (b - 1)(\sigma^2 + v\sigma^2_B),
\end{eqnarray}
where $v$ denotes the size of each block. Subsequently, the EMS is calculated by dividing the ESS by the corresponding DF. Hence, the EMS of the Between Blocks stratum is $\sigma^2 +v\sigma^2_B$. Similarly, the EMS of the Within Blocks stratum can be shown as $\sigma^2$. The theoretical ANOVA table without the treatment components for RBD is shown in Table~\ref{tab:infoDecomp}.

\begin{table}[ht]
\centering
\caption{ANOVA with the coefficients of variance components of the EMS from a single phase experiment arranged with RCBD.}
\begin{tabular}[t]{lllll}
\toprule
 \multicolumn{1}{l}{\bf Source of Variation}& \multicolumn{1}{l}{\bf Vector (Sub)space} & \multicolumn{1}{l}{\bf DF} & \multicolumn{1}{l}{\bf SS} & \multicolumn{1}{l}{\bf EMS}\\
\midrule
Between Blocks 	& $\mathbb{V}_1$ &$b-1$ & $\bm{y}'(P_{Z_B}-K)\bm{y}$	& $\sigma^2 + v\sigma_{B}^2$\\
Within Blocks 	& $\mathbb{V}^{\perp}_1 = \mathbb{V}_2$	&$b(v - 1)$ & $\bm{y}'(I - P_{Z_B})\bm{y}$  & $\sigma^2$\\
\hline
Adjusted Total	& $\mathbb{V}^{\perp}_0$	& $n - 1$ & $\bm{y}'(I - K)\bm{y}$ \\
\hline
Grand Mean	& $\mathbb{V}_0$	& $1$ & $\bm{y}'K\bm{y}$ \\
\midrule
Total 	& $\mathbb{R}^n$	& $n$ & $\bm{y}'\bm{y}$ \\
\bottomrule
\end{tabular}
\label{tab:infoDecomp}
\end{table}

\subsection{Computing the treatment SS}
\label{subsec:estTrt}
The previous section overview of the process to computing the SS and EMS from the null decomposition, the next step is to compute the treatment SS and EMS within each stratum. In order to compute the treatment SS, it is necessary to have the treatment design matrix, $X$ defined in (\ref{eq:matrixLMM}), and another set of matrices. This set of matrices are known as the treatment contrast matrices, denoted by $C_x$ \citep{John1987}. These matrices can be generated, based on the treatment structure and \emph{yield identity}, which describes how the treatment effects are partitioned into orthogonal components. 

Consider an example where the treatment structure consists of a single treatment factor is denoted by $\alpha_i$, $i= 1,\dots, v$, the yield identity is given by
\begin{equation}\label{eq:yieldIdenity}
\alpha_{i} = \overline{\alpha_{.}}+(\alpha_{i} -\overline{\alpha_{.}})
\end{equation}
The dot in the subscript denotes the summation over the subscript it replaces and the over-line, also known as \emph{bar}, indicates the average over the terms associated with the nominal subscript. Thus, $\overline{\alpha_{.}}$ denotes the overall mean of the $\alpha_i$. The term, $\alpha_{i} -\overline{\alpha_{.}}$, denotes the effect of treatment $i$ corrected from the mean. In matrix notation, (\ref{eq:yieldIdenity}) can be written as 
\[
\bm{\alpha} = C_0 \bm{\alpha} + C_1 \bm{\alpha}
\]
where
\begin{eqnarray}
\nonumber C_0 &=& K_v\\
\nonumber C_1 &=& I_v - K_v
\end{eqnarray}
where $I_v$ is $v \times v$ identity matrix and $K_v$ is $v \times v$ averaging matrix. The $C_0 \bm{\alpha} $, corresponds to $\overline{\alpha_{.}}$, can be seen as an operation which averages over the $\alpha_i$. The $C_1\bm{\alpha}$, corresponds to $\alpha_{i} - \overline{\alpha_{.}}$, represents the effects of the treatment after the mean is swept.

Consider the factorial experiment with two factors $\tau$ and $\gamma$ at $v_1$ and $v_2$ levels, the yield identity of $\alpha_{ij}$ can be written as,
\begin{equation}
\label{eq:yieldIdentityFactorial}
\alpha_{ij} = \overline{\alpha_{..}}+(\overline{\alpha_{i.}} -\overline{\alpha_{..}}) + (\overline{\alpha_{.j}} -\overline{\alpha_{..}}) +(\alpha_{ij} + \overline{\alpha_{i.}} + \overline{\alpha_{.j}} -\overline{\alpha_{..}}),
\end{equation}
where $\overline{\alpha_{..}}$ denotes the overall mean of $\alpha_{ij}$, $\overline{\alpha_{i.}} -\overline{\alpha_{..}}$ denotes the main effects of factor $\tau$, $\overline{\alpha_{.l}} -\overline{\alpha_{..}}$ denotes the main effects of factor $\gamma$ and $\alpha_{ij} + \overline{\alpha_{i.}} + \overline{\alpha_{.j}} -\overline{\alpha_{..}}$ is the interaction of two treatment factors. In the matrix notation, (\ref{eq:yieldIdentityFactorial})can be written as
\[
\bm{\alpha} =  C_{00} \bm{\alpha} +   C_{10} \bm{\alpha} +   C_{01} \bm{\alpha} +   C_{11} \bm{\alpha} 
\]
where
\begin{eqnarray}
\nonumber C_{00} = & K_{v_1} \otimes K_{v_2}& = K_{v_1 v_2}\\
\nonumber C_{10} = & I_{v_1} \otimes K_{v_2} - K_{v_1 v_2}& = (I_{v_1} - K_{v_1}) \otimes K_{v_2} \\
\nonumber C_{01} = &K_{v_1} \otimes I_{v_2} - K_{v_1 v_2}& =  K_{v_1} \otimes (I_{v_2} - K_{v_2})\\
\nonumber C_{11} = &I_{v_1 v_2}-I_{v_1} \otimes K_{v_2} - K_{v_1} \otimes I_{v_2} + K_{v_1 v_2} &= (I_{v_1} - K_{v_1}) \otimes (I_{v_2} - K_{v_2}).
\end{eqnarray}

Notices the experiment with single treatment factor, the $C$ matrix is  
\begin{equation}
\label{eq:contrMat}
C_{x_i} =
   \begin{cases}
       K_{v_i}, & x_i = 0 \\
       I_{v_i} - K_{v_i}, & x_i = 1,
    \end{cases}
\end{equation}
where $x_i$ is a binary number. For the $v_1 \times v_2$ factorial experiment, the $C$ matrix is given by 
\[
C_{x_1 x_2} = C_{x_1} \otimes  C_{x_2}. 
\]

Therefore, the treatment structure of an $N$-factor experiment is given by 
\begin{equation}
\bm{\alpha} = \sum_x{C_x\bm{\alpha}}
\end{equation}
where the $x$ is a set of binary numbers, $(x_1 x_2 \dots x_{N})$, and 
\[
C_x =  C_{x_1} \otimes  C_{x_2} \otimes \dots \otimes  C_{x_{N}} = \bigotimes^{N} _{i = 1} C_{x_i},
\]
where $ C_{x_i}$ is the treatment contrast matrix defined in (\ref{eq:contrMat}) \citep{John1987}.

The reduced normal equations for the treatment parameter can then be defined by eliminating the mean and block parameters from the full set of normal equations~\citep{John1987}. This can be shown as
\[
A_i\bm{\alpha} = \bm{q}_i,
\]
where
\begin{eqnarray*}
A_i &=& C_x X' Q_i X C_x ,\\
\bm{q}_i &=& C_x X' Q_i \bm{y},
\end{eqnarray*}
where $A_i$ denotes the information matrix and $\bm{q}_i$ is vector of the adjusted treatment totals. Since we are estimating the treatment effects, the equation is rewritten with respect to $\bm{\alpha}$ as
\begin{equation}
\label{eq:trtVec}
\bm{\alpha} = A_{i}^{-} \bm{q}_i = (C_x X' Q_i XC_x )^{-}C_x X' Q_i \bm{y},
\end{equation}
where $A_{i}^{-}$ is a generalised inverse of $A_{i}$ satisfying $A_{i} A_{i}^{-} A_{i} = A_{i}$. The generalised inverse of matrix is applied, because the information matrix can be a singular matrix, which cannot be inverted using the normal inverse operation. Hence, $A_{i}^{-} \bm{q}_i$ denotes the treatment vector in the $i$th vector subspace or stratum. The treatment SS for the $i$th stratum is given by
\begin{equation}
\label{eq:trtSS}
\bm{q}_{i}' A_{i}^{-} \bm{q}_{i}.
\end{equation}
Providing the SS of $i$th stratum is $\bm{q}_{i}'\bm{q}_{i} = \bm{y}' Q_i\bm{y}$, the residual SS can be computed by subtraction as 
\begin{equation}
\label{eq:resSS}
\bm{q}_{i}'\bm{q}_{i} - \bm{q}_{i}' A_{i}^{-} \bm{q}_{i} = \bm{q}_{i}' ( I -A_{i}^{-}) \bm{q}_{i},
\end{equation}
where $Q_iX C_x A_{i}^{-}C_x X' Q_i$ and $Q_iX C_x ( I - A_{i}^{-}) C_x X' Q_i$ in $\bm{q}_{i}' A_{i}^{-} \bm{q}_{i}$ and $\bm{q}_{i}' ( I -A_{i}^{-}) \bm{q}_i$ are the orthogonal projectors that decomposes the unadjusted SS, $\bm{y}' \bm{y}$, to the treatment SS and residual SS in stratum $i$, respectively. These two orthogonal projectors are used to compute the coefficients of the variance components in the treatment and residual ESS as described in (\ref{eq:ESSQuad}).

The Equation~(\ref{eq:trtSS}) can be shown as 
\begin{equation}\label{eq:projTrtBlock}
 \bm{q}_{i}' A_{i}^{-} \bm{q}_{i} = \dfrac{1}{r_t} \sum^{v - 1}_{j = 1} e_j^{-1} (\bm{p}_i' \bm{q}_{i})^2
\end{equation}
where $r_t$ denotes the number of treatment replication, $e_i$ denotes the canonical efficiency factor and $p_i$ are $i$th eigenvector of the treatment information matrix. Given that $\lambda_i$ and $p_i$ are $i$th eigenvalue and eigenvector of the treatment information matrix, the $i$th basic treatment contrast is given by $p_i'\bm{\alpha}$ and the $i$th \emph{canonical efficiency factors} is calculated by $\dfrac{\lambda_i}{r_t}$ \citep{John1987}. The harmonic mean of the canonical efficiency factors, i.e.\
\[
E = \dfrac{v-1}{\sum^{v - 1}_{j = 1} e_j^{-1}},
\]
gives the \emph{average efficiency factor}, denoted by $E$, which is the amount of the treatment information that is present in a stratum of the information matrix derived \citep{Yates1936}. Therefore, Equation~(\ref{eq:trtSS}) provides the estimation of the \emph{efficiency factor adjusted treatment SS}.

Furthermore, the coefficients of the treatment parameters, commonly denoted by $\theta$, of the EMS can be derived directly from the treatment replication. If the design is non-orthogonal, the fixed components' coefficients of the EMS are multiplied by the average efficiency factors to reflect the amount of separation of the treatment information across different strata.

\section{Information decomposition of a two-phase experiment} 
\label{sec:infoiDecompTwoPase}
Section~\ref{sec:infoDecomp} described the information decomposition of a single phase experiment, which consisted of three basic decomposition steps: adjusting for the grand mean, defining the stratum based on the block structures and computing the treatment SS based on the treatment structure in the block structure. 

The two-phase experiments are more complicated than single phase experiments, because they are made up of two sets of block structure from Phase 1 and 2 experiments and the overall treatment structure. The information decomposition of a two-phase experiment starts with the raw data vector being adjusted for the grand mean, the strata from the Phase 2 block structure are then defined. The Phase 2 strata are always defined before the Phase 1 strata, because the Phase 2 strata always contributes to the outer strata of the ANOVA table. The next step is to define the strata of the Phase 1 block structure from each stratum of the Phase 2 block structure. The final step is to estimate the treatment effect in block structure of the Phase 1 experiment. This section describes the information decomposition of the two-phase experiments.

\subsection{The linear mixed-effects model}
\label{subsec:phase2Model}
Consider a two-phase experiment with $n$ observations, the general linear mixed-effect model in the matrix notation, can be written as
\begin{equation}
\label{eq:matrixTwoPhase}
\bm{y} = \bm{1}\mu + X\bm{\alpha} + Z_1\bm{\beta}_1 + Z_2\bm{\beta}_2 + \bm{\epsilon},
\end{equation}
where $Z_1$ and $Z_2$ matrices in model~(\ref{eq:matrixTwoPhase}) are block design matrices for the Phase 1 and Phase 2 experiments, respectively. The vectors of Phase 1 and 2 block parameters are $\bm{\beta}_1$ and $\bm{\beta}_2$, respectively. The block parameter and design matrix from the Phase 2 experiment have the same structure as defined in (\ref{eq:matrixLMM}). However, the block parameter and design matrix from the Phase 1 experiment is constructed with the same way as $X$ and $\bm{\alpha}$ in (\ref{eq:matrixLMM}). Hence, the $\bm{\beta}_1$ and $Z_1$ are constructed by the every combination of the block parameters from the Phase 1 experiments. 

The $\bm{\beta}_1$ and $Z_1$ are constructed this way is because the allocation of block factors from the Phase 1 to the block factors of Phase 2 experiment can be non-orthogonal; thus, the amount of block information from Phase 1 experiments may not stay intact in the strata of the Phase 2 experiments \citep{Brien1999}. Hence, the information decomposition procedure described in Section~\ref{subsec:estTrt} is used by \emph{treating the Phase 1 block structure as the treatment structure}. This can help us to adjust for the efficiency factors while applying the projection from the Phase 1 block vectors onto Phase 2 block spaces as shown in (\ref{eq:projTrtBlock}). 

\subsection{Null decomposition of Phase 2 block structure}
The same notation of $Q_i$ is used for the orthogonal projectors for the stratum $i$ for the block effects arise from the Phase 2 experiment. Since the $\bm{\beta}_2$ vector and $Z_2$ matrix has the same structure as the $\bm{\beta}$ vector and $Z$ matrix for he single phase experiment, the $Q_i$ is constructed with the exact same way as described in Section~\ref{subsec:strataDecompProj}. Thus, the $\bm{y}' Q_i \bm{y}$ denote SS decomposed from total SS, $\bm{y}'\bm{y}$, onto the stratum $i$ of the Phase 2 experiment.   

\subsection{Null decomposition of Phase 1 block structure}
As mentioned in Section~\ref{subsec:phase2Model},  allocation of block factors from the Phase 1 to the block factors of Phase 2 experiment can be non-orthogonal; so the Phase 1 block structure has to be treated as the treatment structure while performing the decomposition. Hence, the method described in Section~\ref{subsec:estTrt} is applied. 

Consider an experiment arranged with a split-block design with $b_1$ blocks and each block containing $b_2$ plots, the $\bm{\beta}_1$  consists of the effects of plots within blocks as    
\begin{equation}\label{eq:blockParSplitBlk1}
 (P_{11}, \dots, P_{b_1 b_2}). 
\end{equation}
where $P_{ij}$ denotes the effect from plot $j$ within block $i$. The effect from block $i$ is denoted by $\overline{P_{i.}}$. Thus, the block design matrix, $Z_1$, is the design matrix of the plots, denoted by $Z_P$, which is as $n \times bp$ matrix. The yield identity of $P_{ij}$ can be written as,
\begin{equation}
\label{eq:yieldIdentityNest}
P_{ij} = \overline{P_{..}}+(\overline{P_{i.}} -\overline{P_{..}}) + (P_{ij} - \overline{P_{i.}}),
\end{equation}
where $\overline{P_{..}}$ denotes the overall mean of $P_{ij}$, $\overline{P_{i.}} -\overline{P_{..}}$ denotes the effect from block $i$ and $P_{ij} - \overline{P_{i.}}$ denotes the effect from plot $j$ within block $i$. In the matrix notation, (\ref{eq:yieldIdentityNest}) can be written as 
\[
\bm{\beta}_1 = C_{00} \bm{\beta}_1 + C_{10}\bm{\beta}_1 + C_{21}\bm{\beta}_1
\]
where
\begin{eqnarray}
\nonumber C_{00} = & K_{b_1} \otimes K_{b_2}& = K_{b_1 b_2}\\
\nonumber C_{10} = & I_{b_1} \otimes K_{b_2} - K_{b_1 b_2}& = (I_{b_1} - K_{b_1}) \otimes K_{b_2} \\
\nonumber C_{21} = & I_{b_1 b_2} - I_{b_1} \otimes K_{b_2} & =  I_{b_1} \otimes (I_{b_2} - K_{b_2}).
\end{eqnarray}
Unlike the $x_i$ in $C_{x_i}$ matrix defined in (\ref{eq:contrMat}) which is a binary number, the block contrast matrix, denoted by $C_z$, can also considered the nested relationship between the block factors. Hence, an additional criterion is included, i.e.\
\begin{equation}
\label{eq:contrMat1}
C_{z_i} =
   \begin{cases}
       K_{b_i}, & z_i = 0 \\
       I_{b_i} - K_{b_i}, & z_i = 1\\
        I_{b_i}, & z_i = 2,
    \end{cases}
\end{equation}
where $z_i$ is a \emph{ternary} number.

Therefore, the Phase 1 block structure consists of $B$-factor, the Phase 1 block parameter is then given by, 
\begin{equation}
\bm{\beta}_1 = \sum_z{C_z\bm{\beta}_1}
\end{equation}
where the $z$ is a set of ternary numbers, $(z_1 z_2 \dots z_{B})$, and 
\[
C_z =  C_{z_1} \otimes  C_{z_2} \otimes \dots \otimes  C_{z_{B}} = \bigotimes^{B} _{i = 1} C_{z_i},
\]
The $C_{z}$ matrix should also be applied to treatment contrast matrix $C_{x}$ defined in (\ref{eq:contrMat} to cover the situation when the relationship between the treatment factors is nested. 

Providing the SS in stratum $i$ is $\bm{y}' Q_i\bm{y}$, SS stratum $j$ from the Phase 1 experiment in stratum $i$ from the Phase 2 experiment is given by 
\[
 \bm{q}_{i}' A_{i}^{-} \bm{q}_{i},
\]
where
\begin{eqnarray*}
A_i &=& C_z Z_1' Q_i  Z_1 C_z,\\
\bm{q}_i &=& C_z  Z_1' Q_i \bm{y},
\end{eqnarray*}
where $A_i$ denotes the block information matrix and $\bm{q}_i$ is vector of the adjusted Phase 1 block effects in stratum $i$.

The residual SS in the stratum $i$ is then derived by subtraction using the same equation in \ref{eq:resSS}, giving $\bm{q}_{i}'(I- A_{i}^{-}) \bm{q}_{i}$.

The matrix $Q_i Z_1 C_z A_{i}^{-}C_z  Z_1' Q_i$ in $\bm{q}_{i}' A_{i}^{-} \bm{q}_{i}$ is re-expressed as $Q_{j(i)}$ which denotes the orthogonal projector of stratum $j$ of the Phase 1 experiment in stratum $i$ of the Phase 2 experiment. The orthogonal projector $Q_{j(i)}$ is then be used to compute the treatment SS as explained in the following subsection.

\subsection{Computing the treatment SS}
\label{subsec:trtDecomp}
The next step is the information decomposition with respect to the treatment structure. Since the vector of treatment parameters, $\bm{\alpha}$ considered the treatment parameters from both Phase 1 and Phase 2 experiments, the information decomposition procedure is identical to the single phase experiment. 

The only differences in the orthogonal projector. If the decomposition is in the stratum $j$ from the Phase 1 experiment within the stratum $i$ from the Phase 2 experiment, the orthogonal projector is expressed as $Q_{j(i)}$. The treatment SS can then be shown as
\[
\bm{q}_{j(i)}' A_{j(i)}^{-} \bm{q}_{j(i)},
\]
where
\begin{eqnarray*}
A_{j(i)} &=& C_x X' Q_{j(i)} X C_,\\
\bm{q}_{j(i)} &=& X C_x)^{-} C_x X' Q_{j(i)} \bm{y},
\end{eqnarray*}
where $A_{j(i)} $ denotes the information matrix and $\bm{q}_{j(i)}$ is vector of the adjusted treatment totals.

The residual SS can then be computed by subtraction of the SS of the stratum $j$ ib the Phase 1 experiment within stratum $i$ in the Phase 2 experiment, denoted by $\bm{q}_{j(i)}'\bm{q}_{j(i)} = \bm{y}' Q_{j(i)} \bm{y}$, by the treatment SS, resulting
\[
\bm{q}_{j(i)}' (I - A_{j(i)}^{-}) \bm{q}_{j(i)},
\]
The coefficients of the variance and fixed components are then calculated as explained in Section~\ref{sec:infoDecomp}.

The information decomposition for the two-phase experiment is described in this section. The major difference to the single-phase experiment is an additional decomposition procedure of Phase 1 block factors to the Phase 2 factors. Furthermore, since the block structure can be non-orthogonal, this additional decomposition procedure has has to performed the same way as decomposing the treatment factors to block factors of the single-phase experiment. Thus, the vector of block parameters and matrix of block design for the Phase 1 experiment are constructed differently to the block parameter of the single-phase experiment.  

\section{Two-phase proteomics experiment} 
\label{sec:exampleTwoPase}
A \emph{quantitative proteomics experiment} is aiming to identify proteins that are differentially abundant between animals under different conditions of interest. This experiment can be treated as a two-phase experiment, where the animals are randomly perturbed to the conditions of interest in the Phase 1 experiment. Since the abundance of proteins cannot be measured directly from the animals, the Phase 2 experiment uses some biotechnologies to measure the abundances of proteins in the samples extracted from the organisms in the Phase 1 experiment. 

One method to measure the protein abundances is \emph{Multi-dimensional Protein Identification Technology} (MudPIT), which is the series of instruments used to separate a protein mixture, based on their chemical properties, before measuring the abundance of each protein specie \citep{Florens2006a}. These series of separations allow a more accurate protein abundance measurement. However, the comparison of protein abundances between samples is difficult due to large variabilities between different MudPIT experiments. This limitation has been resolved with the introduction of \emph{isobaric Tags for Relative and Absolute Quantitation} (iTRAQ$^{\rm TM}$) which enables the simultaneous analysis of up to eight distinct samples within a single MudPIT experiments \citep{Ross2004, Choe2007}. This article refers to each MudPIT experiment as a run and iTRAQ$^{\rm TM}$ tag as tag. The statistical aim is to find the best way to allocate the samples generated from the Phase 1 experiment to which runs and tags of Phase 2 experiment.

The two-phase experiments is made up of three design structures: the block structures of the Phase 1 and Phase 2 experiments and treatment structures of overall experiment. The block structures of the Phase 1 experiment is composed of Between Animals and Between Samples Within Animals. The block structure of the Phase 2 experiment is composed of Between and Within Runs. The treatment structure of this experiment is composed of disease status and tag, since the disease status and tag effects are assumed to not interact. 

This section presents an example of two-phase proteomics experiment where the Phase 1 experiment consists of eight animals randomly assigned to either the healthy or diseased groups and the Phase 2 experiment consists of four runs and fours tags. Both Phase 1 and Phase 2 experimental designs and their theoretical ANOVA tables are described. 

\subsection{Phase 1 experiment}
\label{subsec:Phase1Exp}
The experimental objective of the Phase 1 experiment is to compare treatment groups in the absence of nuisance sources of variation \citep{Mead1988}. Thus, the Phase 1 experiment is arranged in a completely randomised design. As there are eight animals in this experiment, four animals can be randomly assigned to either the healthy or diseased group as shown Table~\ref{tab:phase1Design}. The four animals in each treatment groups are used to assess the biological variation and known as \emph{biological replicates}. Note that Phase 2 experiment uses four runs and four tags; hence, a total of 16 samples are processed. Given there are eight animals from the Phase 1 experiment, each animal is further subdivided to two identical samples which is used for assessing the measurement error of the Phase 2 experiment experiment, these samples are also known as \emph{technical replicates}.

\begin{table}[ht]
\centering
\caption{Phase 1 design shows the assignment of animals to disease status' groups where the upper case letters denote the animal ID.}
\begin{tabular}[t]{ccccc}
\hline 
Healthy & A & C & E & G \\ 
Diseased & B & D & F & H \\ 
\hline 
\end{tabular} 
\label{tab:phase1Design}
\end{table}

Let $y_{ij(k)}$ denote the abundance of a given protein in sample $k$ of rat $i$ under disease status $j$. Then, the linear model of the Phase 1 design is given by
\begin{equation}\label{eq:phase1Model}
y_{ij(k)}= \mu + A_{i} + \tau_{j} \; (+ \epsilon_{ijk} ),
\end{equation}
where $\mu$ denotes grand mean from all observations, $\tau_{j}$ denotes the fixed effect of disease status $j$, $j=$ healthy, diseased, and $A_{i}$ denotes the effects from rat $i$, $i=$ A,$\dots$, H. The $\epsilon_{ijk}$ denotes the dummy variable associated with the technical replicate from sample $k$ of rat $i$ under disease status $j$, ($k = 1, 2$). Despite the technical replicates is used to assessing the measurement error of the Phase 2 experiment, it is considered in the model of the Phase 1 experiment, because the combination of indexes from the Phase 1 experiment must be uniquely corresponded to the indexes of the Phase 2 experiment. For example, the first sample of rat A under healthy group can be assigned to run 1 and tag 114. However, the term $\epsilon_{ijk}$ does not contribute to the analysis, because the technical replicate is used to estimate the measurement error in Phase 2 experiment; hence, there are treated as the dummy index and variable with parentheses as shown in the model (\ref{eq:phase1Model}). 

Since the the treatments are applied on the animals and animals are the smallest units on which a responses is measured, the animals are both experimental and observational units \citep{Bailey2008}. Hence, the animals to animals variation is confounded with the measurement error. Furthermore, the animal effects are assumed to be normally distributed with mean zero and variance of $\sigma_{A}^2$.

The theoretical ANOVA table for the Phase 1 experiment is shown in Table~\ref{tab:Phase1ANOVA}. The last column of this theoretical ANOVA table is the EMS which is the linear combination of the variance components. These EMS are made up of the variation between animals, $\sigma_{A}^2$, and the treatment component for disease statuses, $\theta_{\tau}$. Given that $DF_{\tau}$ denote the DF of disease status, $\theta_{\tau}$ is defined as 
\[\frac{\displaystyle \sum_{j = healthy, diseased}(\tau_{j} - \overline{\tau_{.}})^2}{DF_{\tau}}=
\frac{(\tau_{healthy} - \overline{\tau_{.}})^2 + (\tau_{diseased} - \overline{\tau_{.}})^2}{2-1},\] 
which is the variances between the treatment means. The coefficients of these components can be derived from the replication numbers of their corresponding factors. 

If the samples are considered, then there are total of 16 observations in the Phase 1 experiment. Since the differences between the samples does not contribute to the analysis, the total number of observation for the Phase 1 experiment is then 8, i.e.\ the number of animals. Hence, the DF associated with the adjusted total of Phase 1 experiment is 7. Since the animals are both experimental and observational units, the Between Animals stratum captured the overall analysis. Furthermore, the Between Animals stratum is further decomposed to 1 and 6 DF for the effects of disease status and residual, respectively. A valid test for disease status effects can be conducted for this Phase 1 experiment, since the coefficients of the variance components of disease status and Residual EMS are identical. Hence, providing that the experimental data can be obtained, the F-ratio can be calculated from the disease status and the residual mean squares. 

%Note that the effects between the technical replicates does not contribute to the analysis of the Phase 1 experiment; so the variance components associated with the experimental error, $\sigma^2$, does not appear in the any EMS of the theoretical ANOVA table. 

\begin{table}[ht]
\centering
\caption{Phase 1 ANOVA with the coefficients of variance components of the EMS.}
\begin{tabular}[t]{lrl}
\toprule
\multicolumn{1}{l}{\textbf{Source of Variation}} & \multicolumn{1}{l}{\textbf{DF}} & \multicolumn{1}{l}{\textbf{EMS}}\\
\midrule
Between Animals 		\\
\hspace{3mm}Disease status 	& $1$ 	& $\sigma_{A}^2 + 4\theta_{\tau}$\\
\hspace{3mm}Residual		& $6$ 	& $\sigma_{A}^2$\\\hline
Total 						& $7$    & \\
\bottomrule
\end{tabular}
\label{tab:Phase1ANOVA}
\end{table}

\subsection{Phase 2 experiment}
\label{subsec:Phase2Exp}
In practice, the protein abundances cannot be measured directly from the animals; so the Table~\ref{tab:Phase1ANOVA} cannot be used for conducting the test of treatment effects. Hence, it is necessary to harvest the tissues and extract the proteins from the animals for the subsequent Phase 2 MudPIT-iTRAQ$^{\rm TM}$ experiment. Hence, two additional components are introduced, i.e.\ the variation between runs, $\sigma_{R}^2$, and the difference between tags, $\theta_{\gamma}$. In addition, the variation between the samples, $\sigma^2$, is present for assessing the experimental error. 

This example uses four MudPIT runs with a four-plex iTRAQ$^{\rm TM}$ labelling system to measure protein abundances; hence, a total of 16 samples are processed. The 16 samples generated from Phase 1 can be directly allocated to MudPIT-iTRAQ$^{\rm TM}$ using a four-by-four grid. The goal of the design is to estimate the differences in protein abundance between the treatment groups as precisely as possible. This is achieved by ensuring that the fixed effects can be estimated independently of the random effects, i.e., they are not \emph{confounded} with the random effects.

The assignment of disease status is done using a Latin square design. However, there are eight rats available in this experiment and only four MudPIT runs of four-plex iTRAQ$^{\rm TM}$ labelling system are used, so any assignment of animals is unavoidably confounded with runs and tags. Hence, the aim of the assignment is to minimise the amount of confounding. A tabular representation of the Phase 2 design is shown in Table~\ref{tab:phase2Design}. The confounding of animals with runs occurs when comparing between Run 1, 3 and Run 2, 4, hence, one DF of animal is confounded with run. Likewise, the confounding of animals with tags occurs when comparing between Tag 114, 116 and Tag 115, 117, so one DF for tag is confounded with animal. The structure of the ANOVA with the DF is presented in Table~\ref{tab:Phase2ANOVA}.

\begin{table}[ht]
\centering
\caption{Phase 2 design showing the animal assignment to runs and tags. The letters denote animal ID.}
\begin{tabular}[t]{c|cccc}
 & \multicolumn{4}{c}{{\bf Tag}} \\
{\bf Run}  & 114 & 115 & 116 & 117 \\ 
\hline 
1 & A & B & C & D \\ 
2 & F & E & H & G \\ 
3 & C & D & A & B \\ 
4 & H & G & F & E \\ 
\end{tabular} 
\label{tab:phase2Design}
\end{table}

Let $y_{ijk}^{lm}$ denote the abundances of a given protein in sample $k$ of rat $i$ under disease status $j$ and measured from the $l$th MudPIT run with iTRAQ$^{\rm TM}$ tag $m$. The superscript and subscript indexes of response, $y_{ijk}^{lm}$, correspond to the indexes from the Phase 2 experiment and Phase 1 experiment, respectively. The linear model of the Phase 2 experiment is then given by
\begin{equation}\label{eq:phase2Model}
y_{ijk}^{lm}= \mu + R_{l} + A_{i}+ \tau_{j} + \gamma_{m} + \epsilon_{ijk}^{lm},
\end{equation}
where $R_{l}$ denotes the random effects from run $l$,  $l=1,\dots, 4$, $\gamma_{m}$ denotes the fixed effects of tag $m$, $m = 114,\dots, 117$, $\epsilon_{ijk}^{lm}$ denotes the effects from sample $k$, $k = 1, 2$, in animal $i$ from run $l$ under disease status $j$ and tag $m$. In addition, $\epsilon_{ijk}^{lm}$ also denotes an experimental error, because the sample is the smallest unit of the Phase 2 experiment. The remaining terms are defined as in~(\ref{eq:phase1Model}). Furthermore, the run effects and experimental error are assumed to be normally distributed with mean zero and variance of $\sigma_{R}^2$ and $\sigma^2$, respectively. The disease status and tag effects are assumed to not interact. 

Using the information decomposition method described in Section~\ref{sec:infoiDecompTwoPase}, the theoretical ANOVA table of the Phase 2 experiment can be generated and shown in Table~\ref{tab:Phase2ANOVA}. Since there are total of 16 observations, the total number of DF is 15 DF. These 15 DF are decomposed to 3 and 12 DF for Between and Within Runs strata, respectively. The Between Runs stratum is further decomposed to the effects of Between Animals and residual with 1 and 2 DF, respectively. The Within Runs stratum is decomposed to 6 and 6 DF for Between Animals and Between Samples Within Animals strata, respectively. The Between Animals Within Runs is further decomposed to the effects of disease status (1 DF), tag (1 DF) and residual (4 DF). Note that all of the disease status information stay intact in the Between Animals Within Runs stratum. Finally, the Between Sample Within Animals Within runs is decomposed to the effects of tag (2 DF) and residual (4 DF).

Comparing this ANOVA table (Table~\ref{tab:Phase2ANOVA}) to the ANOVA table of Phase 1 experiment (Table~\ref{tab:Phase1ANOVA}), the animals originally have 7 DF; however, 1 DF of the animals is now in the Between Runs stratum and another 1 DF is confounded with the tag effects. A valid test for the disease status effect can still be conducted in the Between Animals Within Runs stratum, but the DF of the residual is reduced from 6 to 4, which may affect the outcome of the test.

\begin{table}[ht]
\centering
\caption{Phase 2 ANOVA with the coefficients of the variance components of EMS.}
\begin{tabular}[t]{lrl}
\toprule
\multicolumn{1}{l}{\textbf{Source of Variation}} & \multicolumn{1}{l}{\textbf{DF}} & \multicolumn{1}{l}{\textbf{EMS}}\\
\midrule
Between Runs 		\\
\quad Between Animals & $1$ 	& $\sigma^2 + 2\sigma_{A}^2 + 4\sigma_{R}^2$\\
\quad Residual		& $2$ 	& $\sigma^2 + 4\sigma_{R}^2$\\
\hline
Within runs 				\\
\quad Between Animals \\
\quad\quad Disease status  & $1$ 	& $\sigma^2 + 2\sigma_{A}^2 + 8\theta_{\tau}$\\
\quad\quad Tag				& $1$ 	& $\sigma^2 + 2\sigma_{A}^2 + 4\theta_{\gamma}$\\
\quad\quad Residual		& $4$ 	& $\sigma^2 + 2\sigma_{A}^2$\\\hline
\quad Between Samples Within Animals		&\\
\quad\quad Tag				& $2$ 	& $\sigma^2 + 4\theta_{\gamma}$\\
\quad\quad Residual		& $4$ 	& $\sigma^2$\\
\hline
Total 						& $15$      & \\
\bottomrule
\end{tabular}
\label{tab:Phase2ANOVA}
\end{table}


\section[InfoDecompuTE]{An \proglang{R} package: \pkg{InfoDecompuTE}} \label{sec:package}
\pkg{InfoDecompuTE} is written in the well known \proglang{R} programming language. This package automatically performs the decomposition procedure, described in Section~\ref{sec:exampleTwoPase}, and produce the theoretical ANOVA table similar to Table~\ref{tab:Phase2ANOVA}. The main purpose of this package is to allow the researchers to study the properties of the theoretical ANOVA of various experimental designs rapidly. This package is made up of series of functions used to construct the theoretical ANOVA tables. This article focuses on two main functions: \code{summaryAovOnePhase} and \code{summaryAovTwoPhase} for single and two-phase experiments, respectively. 

This section first explains the installation procedure of this package and then the arguments that are needed for the two functions: \code{summaryAovOnePhase} and \code{summaryAovTwoPhase}.

\subsection{Installation instructions}
\pkg{InfoDecompuTE} requires a recent version of the \proglang{R} statistical programming environment which is available from the Comprehensive R Archive Network at \url{http://CRAN.R-project.org/} \citep{R2012}. The system requirements for this package depends on the number of factors and observations in the experimental design that the user plans to analyse. This is because the number of factors and observations affects the dimensions of matrices for computation. \citeauthor{Brien1999}'s \citeyearpar{Brien1999} two-phase experiment can be analysed in under a minute using two-gigabytes of RAM with a Duo Core 3GHz machine running Microsoft Windows 7 (Section~\ref{sec:example}).

Given that the user has an internet connection, \pkg{infoDecompuTE} can be installed and initiated by typing the following two commands in a new \proglang{R} session: 
\begin{CodeChunk}
\begin{CodeInput}
> install.packages("infoDecompuTE")
> library("infoDecompuTE")
\end{CodeInput}
\end{CodeChunk}
The package can also be downloaded from \url{http://cran.r-project.org/web/packages/infoDecompuTE/index.html}.


\subsection{Functions}
This section explains the arguments for the two main functions in the \pkg{infoDecompuTE} package, these two functions and their arguments are:
\begin{CodeChunk}
\begin{CodeInput}
summaryAovOnePhase(design.df, blk.str, trt.str, var.comp = NA,
                trt.contr = NA, contr.matrix = all(is.na(trt.contr)),
                table.legend = FALSE, response = NA, latex = FALSE,
                fixed.names = NA)
                
summaryAovTwoPhase(design.df, blk.str1, blk.str2, trt.str, var.comp = NA, 
                blk.contr = NA, trt.contr = NA, 
                contr.matrix = all(is.na(trt.contr)),  table.legend = FALSE,
                response = NA, latex = FALSE, fixed.names = NA)
\end{CodeInput}
\end{CodeChunk}
The rest of this section exlains each of these arguments using the two-phase experiment example described in Section~\ref{sec:exampleTwoPase}.

\subsection{Design data frame}
The first argument, \code{design.df}, consists of the experimental design in a data frame format. The class of each vector in the data frame should be factor. The single-phase and two-phase experimental design in Table~\ref{tab:phase1Design} and \ref{tab:phase2Design} can be shown in two data frames: \code{design1} and \code{design2}. The contents of these two data frames are
\begin{CodeChunk}
\begin{CodeInput}
> design1
\end{CodeInput}
\begin{CodeOutput}
  Ani      Trt
1   A  healthy
2   B diseased
3   C  healthy
4   D diseased
5   E diseased
6   F  healthy
7   G diseased
8   H  healthy
\end{CodeOutput}

\begin{CodeInput}
> design2
\end{CodeInput}
\begin{CodeOutput}
   Run Ani Sam Tag      Trt
1    1   A   1 114  healthy
2    1   B   1 115 diseased
3    1   C   1 116  healthy
4    1   D   1 117 diseased
5    2   E   1 114 diseased
6    2   F   1 115  healthy
7    2   G   1 116 diseased
8    2   H   1 117  healthy
9    3   C   2 114  healthy
10   3   D   2 115 diseased
11   3   A   2 116  healthy
12   3   B   2 117 diseased
13   4   G   2 114 diseased
14   4   H   2 115  healthy
15   4   E   2 116 diseased
16   4   F   2 117  healthy
\end{CodeOutput}
\end{CodeChunk}
where \code{Run} denotes MudPIT runs, \code{Ani} denotes animal ID, \code{Sam} denotes samples, \code{Tag} denotes iTRAQ$^{\rm TM}$ tags and \code{Trt} denotes disease status.

\subsection{Block and treatment structures}
The arguments \code{blk.str} and \code{trt.str} allows the user to input the block and treatment structures, respectively. The \citeauthor{Wilkinson1973}' syntax is used to present these two structures, this presentation is also known as \emph{structure formula} \citep{Wilkinson1973}. The user can also refer to the \code{formula} function in \proglang{R} for further information on the structure formula. (This will be in the intro of my thesis.) 
 
For a single-phase experiment, the relationships between block and treatment factors are represented by two arguments: \code{blk.str} for block factors and \code{trt.str} for treatment factors. For the first phase experiment (Section~\ref{subsec:Phase1Exp}), the structure formula for the block factors is \code{Ani/Sam} which denotes the two technical replicated samples nested from the animals. 

The structure formula for the treatment factor contains a single term for the disease status, \code{Trt}. The output from \code{summaryAovOnePhase} is 
\begin{CodeChunk}
\begin{CodeInput}
> summaryAovOnePhase(design1, blk.str = "Ani", trt.str = "Trt") 
\end{CodeInput}
\begin{CodeOutput}
$ANOVA
            DF Ani
Between Ani       
   Trt      1  1  
   Residual 6  1  

$EF
            Trt eff.Trt
Between Ani            
   Trt      4   1      
\end{CodeOutput}
\end{CodeChunk}
The output is a list of two tables. The first table, denoted by \code{ANOVA}, is the random effects table which gives the DF with the coefficients of the variance components for each source of variation.   The \code{Between Ani} denotes Between Animals stratum. The second table, denoted by \code{EF}, is the fixed effects table provides the coefficients of the fixed components with the average efficiency factors. The efficiency factor is denoted by \code{eff.Trt}. This example indicates all the disease status information is in the Between Animals stratum.

In order to analyse two-phase experiments, the function \code{summaryAovTwoPhase} is used. Recall the two-phase experiment from Section~\ref{subsec:Phase2Exp}, the Phase 1 block structure consists of animals  and Phase 2 block structure is MudPIT run. The Phase 1 and 2 block structures are represented by the arguments \code{blk.str1} and \code{blk.str2}, and their structure formulae can be written as \code{Ani} and \code{Run}, respectively.

The treatment structure is defined in the argument \code{trt.str}. Since the diseases status and tag do not interact, the structure formula can be written as \code{Tag + Trt}. The tag effects should always be fitted to the ANOVA model before the disease status effects or any other treatment effects of interest. This is because if there is confounding between the tag effects and diseases status effects and the diseases status is fitted before the tags, then some of the tag information will be present in the diseases status MS and test for the disease status effects will not be as accurate. 

The output from the \code{summaryAovTwoPhase} of the two-phase experiment from Section~\ref{subsec:Phase2Exp} is
\begin{CodeChunk}
\begin{CodeInput}
> summaryAovTwoPhase(design2, blk.str1 = "Ani", blk.str2 = "Run", 
+ trt.str = "Tag + Trt")                                      
\end{CodeInput}
\begin{CodeOutput}
$ANOVA
               DF e Ani Run
Between Run                
   Between Ani 1  1 2   4  
   Within Ani  2  1 0   4  
Within Run                 
   Between Ani             
      Tag      1  1 2   0  
      Trt      1  1 2   0  
      Residual 4  1 2   0  
   Within Ani              
      Tag      2  1 0   0  
      Residual 4  1 0   0  
$EF
               Tag Trt eff.Tag eff.Trt
Between Run                           
   Between Ani                        
   Within Ani                         
Within Run                            
   Between Ani                        
      Tag      4       1              
      Trt          8           1      
   Within Ani                         
      Tag      4       1              
\end{CodeOutput}
\end{CodeChunk}
The structure of the output is identical to the output from \code{summaryAovOnePhase} and is similar to the ANOVA Table~\ref{tab:Phase2ANOVA}. The second column name of the ANOVA table, \code{e}, denote the variance component of experimental error. Note the \code{Within Run} and \code{Within Ani} denote the Within Runs and Within Animals strata, respectively. 

A more informative way to construct the block structure of the Phase 1 experiment for the current example is to include the sample factor. The Phase 1 block structure is then samples nested from the animals, i.e.\ \code{Ani/Sam} and the output from the \code{summaryAovTwoPhase} becomes
\begin{CodeChunk}
\begin{CodeInput}
> summaryAovTwoPhase(design2, blk.str1 = "Ani/Sam", blk.str2 = "Run", 
+  trt.str = "Tag + Trt")                                    
\end{CodeInput}
\begin{CodeOutput}
$ANOVA
                   DF Ani:Sam Ani Run
Between Run                          
   Between Ani     1  1       2   4  
   Between Ani:Sam 2  1       0   4  
Within Run                           
   Between Ani                       
      Tag          1  1       2   0  
      Trt          1  1       2   0  
      Residual     4  1       2   0  
   Between Ani:Sam                   
      Tag          2  1       0   0  
      Residual     4  1       0   0  
$EF
                   Tag Trt eff.Tag eff.Trt
Between Run                               
   Between Ani                            
   Between Ani:Sam                        
Within Run                                
   Between Ani                            
      Tag          4       1              
      Trt              8           1      
   Between Ani:Sam                        
      Tag          4       1               
\end{CodeOutput}
\end{CodeChunk}
The name in the source of variation and variance component for \code{Ani:Sam} denotes samples within animals. Since samples are the observational units, the samples within animals variance component is identical to the variance component for the experimental error. Thus, the column of the ANOVA table with \code{e} is omitted.

\subsection{Crossed or nested}
Typically, we cannot distinguish the output of \code{terms} function  that whether the relationship of two block or treatment factors is nested or crossed. For example, if the sample is assumed to be nested from the animals, then the output from the \code{terms} function gives
\begin{CodeChunk}
\begin{CodeInput}
> attr(terms(~Ani / Sam), "term.labels")
\end{CodeInput}
\begin{CodeOutput}
[1] "Ani"     "Ani:Sam"
\end{CodeOutput}
\end{CodeChunk}
where \code{Ani} denotes the effect of between different animals and \code{Ani:Sam} denotes the effect of between different samples within animals. If the sample is assumed to be crossed from the animals, then the output from the \code{terms} function gives
\begin{CodeChunk}
\begin{CodeInput}
> attr(terms(~Ani * Sam), "term.labels")
\end{CodeInput}
\begin{CodeOutput}
[1] "Ani"     "Sam"     "Ani:Sam"
\end{CodeOutput}
\end{CodeChunk}
where \code{Ani} and \code{Sam} denotes the effects of between different animals and samples, respectively. However, \code{Ani:Sam}, which is identical from the previous output, denotes the interaction effect between the animals and samples. Thus, to distinguish between the nesting and crossing relationship, the interaction effect between the animals and samples is denoted by \code{Ani*Sam}. 

If the animals and samples are assumed to interact, the Phase 1 block structure become \code{Ani*Sam}. The output of \code{summaryAovTwoPhase} can be expressed as
\begin{CodeChunk}
\begin{CodeInput}
> summaryAovTwoPhase(design, blk.str1 = "Ani*Sam", blk.str2 = "Run", 
+ trt.str = "Tag * Trt")                                     
\end{CodeInput}
\begin{CodeOutput}
$ANOVA
                   DF Ani*Sam Sam Ani Run
Between Run                              
   Between Ani     1  1       0   2   4  
   Between Sam     1  1       8   0   4  
   Between Ani*Sam 1  1       0   0   4  
Within Run                               
   Between Ani                           
      Tag          1  1       0   2   0  
      Trt          1  1       0   2   0  
      Residual     4  1       0   2   0  
   Between Ani*Sam                       
      Tag          2  1       0   0   0  
      Residual     4  1       0   0   0  

$EF
                   Tag Trt eff.Tag eff.Trt
Between Run                               
   Between Ani                            
   Between Sam                            
   Between Ani*Sam                        
Within Run                                
   Between Ani                            
      Tag          4       1              
      Trt              8           1      
   Between Ani*Sam                        
      Tag          4       1                  
\end{CodeOutput}
\end{CodeChunk}
Notices the name of sources of variation and the variance component for the interaction effects of animals and sample is \code{Ani*Sam}. This procedure is also applied on the treatment effects. 

\subsection{Artificial strata}
The \code{var.comp} argument allows the researchers to use the artificial strata to facilitate decomposition. For the example in Section~\ref{subsec:Phase2Exp}, four of eight animals can be grouped as an animal set. Animals in first and second sets are denoted by 1 and 2, respectively. This new vector of animal set, denoted by \code{AniSet}, can be generated as
\begin{CodeChunk}
\begin{CodeInput}
> AniSet
\end{CodeInput}
\begin{CodeOutput}
 [1] 1 1 1 1 2 2 2 2 1 1 1 1 2 2 2 2
Levels: 1 2
\end{CodeOutput}
\end{CodeChunk}

Phase 2 block structure is then written as \code{AniSet/Run}, which means MudPIT runs are now nested within the animal sets. Since the purpose of having animal set is to create the artificial strata, there should not be any variation between the animal sets and the variance components associated with the animal set should be zero. To remove the animal set from the variance component estimate, the \code{var.comp} argument is used which contains a vector of characters indicating which variance components should appear in the output table of the random effects. In addition, the user can also use this argument to define the order of the variance components to appear in the output table, i.e.,
\begin{CodeChunk}
\begin{CodeInput}
> summaryAovTwoPhase(design2, blk.str1 = "Ani/Sam", blk.str2 = "AniSet/Run", 
+	trt.str = "Tag + Trt", var.comp = c("Ani:Sam", "Ani", "Run"))                                    
\end{CodeInput}
\begin{CodeOutput}
$ANOVA
                   DF Ani:Sam Ani Run
Between AniSet                       
   Between Ani     1  1       2   4  
Between AniSet:Run                   
   Between Ani:Sam 2  1       0   4  
Within AniSet.Run                    
   Between Ani                       
      Tag          1  1       2   0  
      Trt          1  1       2   0  
      Residual     4  1       2   0  
   Between Ani:Sam                   
      Tag          2  1       0   0  
      Residual     4  1       0   0  

$EF
                   Tag Trt eff.Tag eff.Trt
Between AniSet                            
   Between Ani                            
Between AniSet:Run                        
   Between Ani:Sam                        
Within AniSet.Run                         
   Between Ani                            
      Tag          4       1              
      Trt              8           1      
   Between Ani:Sam                        
      Tag          4       1              
\end{CodeOutput}
\end{CodeChunk}
Note the \code{Within AniSet.Run} denotes Within Runs and Animal Sets where these two factors are connected by a dot.  

\subsection{Manually defined contrasts}
The contrasts for the Phase 1 block and treatment factors can also be specified using the argument \code{blk.contr} and \code{trt.contr}, respectively. The contrasts are made up of lists of numeric vectors. The order of factors needs to be identical to the order of the block and treatment factors in the arguments \code{blk.str1} and \code{trt.str}. The example here illustrates the treatment contrasts, where four iTRAQ$^{\rm TM}$ tags can be represented by three orthogonal contrasts from a classical 2$^k$ design. Thus, the four iTRAQ$^{\rm TM}$ tags can be represented by three contrast vectors representing each orthogonal contrast as shown 
\begin{CodeChunk}
\begin{CodeInput}
> Tag = list(Tag1 = Tag1, Tag2 = Tag2, Tag3 = Tag3)
> Tag
\end{CodeInput}
\begin{CodeOutput}
$Tag1
 [1]  1  1 -1 -1  1  1 -1 -1  1  1 -1 -1  1  1 -1 -1
$Tag2
 [1]  1 -1  1 -1  1 -1  1 -1  1 -1  1 -1  1 -1  1 -1
$Tag3
 [1]  1 -1 -1  1  1 -1 -1  1  1 -1 -1  1  1 -1 -1  1
\end{CodeOutput}
\end{CodeChunk}
 The contrast vector of disease status can be written as
\begin{CodeChunk}
\begin{CodeInput}
> Trt
\end{CodeInput}
\begin{CodeOutput}
 [1] -0.5  0.5 -0.5  0.5  0.5 -0.5  0.5 -0.5 -0.5  0.5 -0.5  0.5  0.5 -0.5  0.5
[16] -0.5
\end{CodeOutput}
\end{CodeChunk}
Note that it is essential to assign names, i.e. \code{Tag1}, \code{Tag2} and \code{Tag3}, for each of the contrast vector for identification in the output table.

Using the design described in Section~\ref{subsec:Phase2Exp}, the treatment contrasts can be input into the function \code{summaryAovTwoPhase}. The argument \code{contr.matrix} is set to \code{TRUE}, as it indicates that we are working with contrast matrices. The output is shown as follows
\begin{CodeChunk}
\begin{CodeInput}
> summaryAovTwoPhase(design2, blk.str1 = "Ani/Sam", blk.str2 = "Run", 
+ trt.str = "Trt + Tag", 
+ trt.contr = list(Trt = Trt, Tag = list(Tag1 = Tag1, Tag2 = Tag2, Tag3 = Tag3)) 
+ contr.matrix = TRUE)                               
\end{CodeInput}
\begin{CodeOutput}
$ANOVA
                   DF Ani:Sam Ani Run
Between Run                          
   Between Ani     1  1       2   4  
   Between Ani:Sam 2  1       0   4  
Within Run                              
   Between Ani                       
      Tag          1  1       2   0  
      Trt          1  1       2   0  
      Residual     4  1       2   0  
   Between Ani:Sam                   
      Tag          2  1       0   0  
      Residual     4  1       0   0  

$EF
                   Tag Trt eff.Tag eff.Trt
Between Run                               
   Between Ani                            
   Between Ani:Sam                        
Within Run                                   
   Between Ani                            
      Tag          4       1              
      Trt              8           1      
   Between Ani:Sam                        
      Tag          4       1              
\end{CodeOutput}
\end{CodeChunk}

In addition, it is possible to break down the treatment factors into multiple orthogonal contrasts to study how these contrasts contribute to each source of variation. This is achieved by setting the argument \code{contr.matrix} to \code{FALSE}. Using the design described in Section~\ref{subsec:Phase2Exp}, the treatment contrasts can be input into the function \code{summaryAovTwoPhase}, and the output is shown as follows,
\begin{CodeChunk}
\begin{CodeInput} 
> summaryAovTwoPhase(design2, blk.str1 = "Ani/Sam", blk.str2 = "Run", 
+ trt.str = "Tag + Trt", 
+ trt.contr = list(Trt = Trt, Tag = list(Tag1 = Tag1, Tag2 = Tag2, Tag3 = Tag3)),
+ contr.matrix = FALSE, table.legend = TRUE)                                
\end{CodeInput}
\begin{CodeOutput}
$ANOVA
$ANOVA$VC
                   DF a b c
Between Run                
   Between Ani     1  1 2 4
   Between Ani:Sam 2  1 0 4
Within Run                 
   Between Ani             
      Tag.TagB     1  1 2 0
      Trt          1  1 2 0
      Residual     4  1 2 0
   Between Ani:Sam         
      Tag.TagA     1  1 0 0
      Tag.TagC     1  1 0 0
      Residual     4  1 0 0

$ANOVA$Legend
[1] "a = Ani:Sam" "b = Ani"     "c = Run"    

$EF
$EF$trt
                   a b c d e f g h
Between Run                       
   Between Ani                    
   Between Ani:Sam                
Within Run                        
   Between Ani                    
      Tag.TagB       4       1    
      Trt                8       1
   Between Ani:Sam                
      Tag.TagA     4       1      
      Tag.TagC         4       1  

$EF$Legend
[1] "a = Tag.TagA"     "b = Tag.TagB"     "c = Tag.TagC"    
[4] "d = Trt"          "e = eff.Tag.TagA" "f = eff.Tag.TagB"
[7] "g = eff.Tag.TagC" "h = eff.Trt"     
\end{CodeOutput}
\end{CodeChunk}
Note that, having broken down the tag contrasts, the random effects table shows that the tag contrast $2$ is in the Between Animals Within Runs stratum, and tag contrasts $1$ and $3$ are in the Between Samples Within Animals Within Runs stratum.

The argument \code{table.legend} allows the users to use letters to represent column names, and then insert a legend at the bottom of the table. In this example,  \code{summaryAovTwoPhase} is set to \code{TRUE}, because once the treatment contrasts are fitted separately, the number of columns in the table of fixed components increases making it difficult to read. 

\subsection{Mean squares computation}
The argument \code{response} allows the computation of the MS from the experimental data. Using the example of Section~\ref{subsec:Phase2Exp}, \code{response} argument can be input with 16 random numbers corresponding to the 16 observations are drawn from the normal distribution, i.e.\ \code{rnorm(16)}. The output is shown as,
\begin{CodeChunk}
\begin{CodeInput} 
> summaryAovTwoPhase(design2, blk.str1 = "Ani/Sam", blk.str2 = "Run", 
+  trt.str = "Trt + Tag", response = rnorm(16))$ANOVA
\end{CodeInput}
\begin{CodeOutput} 
                   DF Ani:Sam Ani Run MS     
Between Run                                  
   Between Ani     1  1       2   4   6.17532
   Between Ani:Sam 2  1       0   4   0.66664
Within Run                                   
   Between Ani                               
      Tag          1  1       2   0   0.02471
      Trt          1  1       2   0   1.73347
      Residual     4  1       2   0   1.08584
   Between Ani:Sam                           
      Tag          2  1       0   0   3.28668
      Residual     4  1       0   0   0.44523
\end{CodeOutput}
\end{CodeChunk}  
Since the fixed effects table is identical to the table without inserting the experimental data, the fixed effects table is omitted from the output shown. The random effects table, however, has an extra column for the mean squares.

\subsection{Latex output}
The output from \proglang{R} is not always easy to read on the screen. The argument \code{latex} allows the user to transform the \proglang{R} output into {\LaTeX} script. Using the example of Section~\ref{subsec:Phase2Exp}, the \code{latex} of the \code{summaryAovTwoPhase} function is then set to \code{TRUE}, i.e.\
\begin{CodeChunk}
\begin{CodeInput} 
> summaryAovTwoPhase(design, blk.str1 = "Ani", blk.str2 = "Run", 
+ trt.str = "Trt + Tag", latex = TRUE, fixed.names = c("\\tau", "\\gamma") ) 
\end{CodeInput}
\begin{CodeOutput}
\begin{table}[ht]
\centering
\caption{Theoretical ANOVA table}
\begin{tabular}[t]{lrlll} 
\toprule 
\multicolumn{1}{l}{\textbf{Source of Variation}} & 
\multicolumn{1}{l}{\textbf{DF}} & \multicolumn{1}{l}{\textbf{EMS}}&
\multicolumn{1}{l}{$\bm{E_{\gamma}}$}&\multicolumn{1}{l}{$\bm{E_{\tau}}$}\\ 
\midrule 
Between Run &  &  & & \\ 
\quad Between Ani & $1$ & $\sigma^2+2\sigma_{A}^2+4\sigma_{R}^2$ & & \\ \hline 
\quad Within Ani & $2$ & $\sigma^2+4\sigma_{R}^2$ & & \\ \hline 
Within Run &  &  & & \\ 
\quad Between Ani &  &  & & \\ 
\quad \quad Tag & $1$ & $\sigma^2+2\sigma_{A}^2+4\theta_{\gamma}$ &$1$ & \\ 
\quad \quad Trt & $1$ & $\sigma^2+2\sigma_{A}^2+8\theta_{\tau}$ & & $1$\\ 
\quad \quad Residual & $4$ & $\sigma^2+2\sigma_{A}^2$ & & \\ \hline 
\quad Within Ani &  &  & & \\ 
\quad \quad Tag & $2$ & $\sigma^2+4\theta_{\gamma}$ &$1$ & \\ 
\quad \quad Residual & $4$ & $\sigma^2$ & & \\ 
\bottomrule 
\end{tabular} 
\label{tab:} 
\end{table} 
\end{CodeOutput}
\end{CodeChunk} 
The output from the compiling the {\LaTeX} script is shown in Table~\ref{tab:ouputFromR}. Two {\LaTeX} packages \code{bm} and \code{booktabs} are required to compile the {\LaTeX} script. 

When the {\LaTeX} script is to be produced, the Greek letters are required to define the fixed effects. Since different experiments can have different set of Greek letters, the users can choose their own set of Greek letters using the argument \code{fixed.names}. Note that this table does not only contain the DF and EMS, it also has the average efficiency factors for all the treatment effects in the last two columns. However, some further modifications may still required to this table, such as adjusting the names in the source of variation, e.g.\ from "Between Ani" to "Between Animals". However, this additional functionality allows a quick way to generate theoretical ANOVA table from the {\LaTeX} scripts.  

\begin{table}[ht]
\centering
 \caption{Theoretical ANOVA table}
 \begin{tabular}[t]{lrlll} 
 \toprule 
 \multicolumn{1}{l}{\textbf{Source of Variation}} & \multicolumn{1}{l}{\textbf{DF}} & \multicolumn{1}{l}{\textbf{EMS}}& \multicolumn{1}{l}{$\bm{E_{\gamma}}$}&\multicolumn{1}{l}{$\bm{E_{\tau}}$}\\ 
 \midrule 
 Between Run &  &  & & \\ 
 \quad Between Ani & $1$ & $\sigma^2+2\sigma_{A}^2+4\sigma_{R}^2$ & & \\ \hline 
 \quad Within Ani & $2$ & $\sigma^2+4\sigma_{R}^2$ & & \\ \hline 
 Within Run &  &  & & \\ 
 \quad Between Ani &  &  & & \\ 
 \quad \quad Tag & $1$ & $\sigma^2+2\sigma_{A}^2+4\theta_{\gamma}$ &$1$ & \\ 
 \quad \quad Trt & $1$ & $\sigma^2+2\sigma_{A}^2+8\theta_{\tau}$ & & $1$\\ 
 \quad \quad Residual & $4$ & $\sigma^2+2\sigma_{A}^2$ & & \\ \hline 
 \quad Within Ani &  &  & & \\ 
 \quad \quad Tag & $2$ & $\sigma^2+4\theta_{\gamma}$ &$1$ & \\ 
 \quad \quad Residual & $4$ & $\sigma^2$ & & \\ 
 \bottomrule 
 \end{tabular} 
  \label{tab:ouputFromR} 
\end{table} 

\section[Example]{Two-phase viticultural experiment using \pkg{InfoDecompuTE}}\label{sec:example}
This section show how the function \code{summaryAovTwoPhase} is used to generate the table of EMS for the viticultural experiment described by \cite{Brien1999}. \citeauthor{Brien1999} used the structure formulae to represent the block and treatment structures in their two-phase experiment. The first phase was the viticultural experiment comparing four different types of trellising and two pruning methods. The second phase involved the evaluation of the wines made from the viticultural experiment.

%\cite{Brien1999} described a two-phase experiment in which the first phase involved a viticultural experiment comparing four different types of trellising and two pruning methods. The second phase involved the sensory evaluation of wines made from the grapes that were grown in the viticultural experiment.

The first phase viticultural experiment was arranged into two adjacent squares, each with three rows and four column blocks. The four trellising methods were assigned to the row blocks as a randomised complete block design and to the column blocks as a BIBD. Furthermore, each plot was halved, and one of two different pruning methods was randomly assigned to each half-plot. Hence, 48 observations were made from the viticultural experiment.

The second phase experiment consisted of six judges evaluating the wines made from the grapes grown in the viticultural experiment. The wines were evaluated on two separate occasions, with wines made from grapes grown within the same square at the first phase being evaluated on the same occasion at the second phase. Each occasion was divided into three intervals, with four sittings per interval. At each sitting, each judge was presented with four glasses of duplicate wines from each of two half-plots from the same main plots in the first phase. \cite{Brien1999} referred to these glasses as the positions. They used the row and column numbers in the viticultural experiment to assign the plots in the evaluation experiment. The two-phase experiment yields a total of 576 measurements.

The structure formulae of Phase 2 and 1 block and the treatment factors are
\begin{eqnarray}
\label{eq:stru1}&&\mathrm{((Occasions/Intervals/Sittings)*Judges)/Positions,}\\
\label{eq:stru2}&&\mathrm{(Rows*(Squares/Columns))/Halfplots}
\end{eqnarray}
and
\begin{equation}\label{eq:stru3}
\mathrm{Trellis*Method.}
\end{equation}
The block structure~(\ref{eq:stru1}) indicates that Sittings are nested within Intervals which are nested within Occasions. However, since all Judges are present at every Sitting, Judges is crossed with Sittings within Intervals within Occasions. Finally, positions are nested within Judges and Sittings because four glasses of wine were evaluated by each Judge at each Sitting. The block structure defined in~(\ref{eq:stru2}) for the Phase 1 experiment indicates that the main plots, to which Trellising methods are assigned, are defined as the Rows crossed with the Columns nested within squares, with Half-plots being nested within plots. The treatment structure defined in~(\ref{eq:stru3}) is a 2-by-2 factorial experiment, thus, Trellising and pruning Methods are crossed.

These three structure formulae and the design are input into the function \code{summaryAovTwoPhase} and the output is as follows:
\begin{CodeChunk}
\begin{CodeInput}
> summaryAovTwoPhase(design, blk.str1 = "(Row*(Squ/Col))/Hal", 
+ blk.str2 = "((Oc/In/St)*Ju)/Pos", trt.str = "Tre*Met", 
+ table.legend = TRUE)
\end{CodeInput}
\begin{CodeOutput}
Note: Complete confounding between Squ and Oc!
$ANOVA
$ANOVA$VC
                              DF  a  b  c  d  e   f   g h i  j  k  l  m  n  
Between Oc                                                                  
   Between SquCCW             1   12 24 96 72 288 0   1 4 16 48 0  24 96 288
Between Oc:In                 4   0  0  0  0  0   0   1 4 16 0  0  24 96 0  
Between Oc:In:St                                                            
   Between SquCCW:Col                                                       
      Tre                     3   4  8  0  24 0   0   1 4 0  0  0  24 0  0  
      Residual                3   4  8  0  24 0   0   1 4 0  0  0  24 0  0  
   Within Row.SquCCW.Col.Hal  12  0  0  0  0  0   0   1 4 0  0  0  24 0  0  
Between Ju                    5   0  0  0  0  0   0   1 4 16 48 96 0  0  0  
Between Oc*Ju                 5   0  0  0  0  0   0   1 4 16 48 0  0  0  0  
Between (Oc:In)*Ju                                                          
   Between Row                2   12 24 96 0  0   192 1 4 16 0  0  0  0  0  
   Between Row*SquCCW         2   12 24 96 0  0   0   1 4 16 0  0  0  0  0  
   Within Row.SquCCW.Col.Hal  16  0  0  0  0  0   0   1 4 16 0  0  0  0  0  
Between (Oc:In:St)*Ju                                                       
   Between SquCCW:Col                                                       
      Tre                     3   8  16 0  48 0   0   1 4 0  0  0  0  0  0  
      Residual                3   8  16 0  48 0   0   1 4 0  0  0  0  0  0  
   Between Row*(SquCCW:Col)                                                 
      Tre                     3   12 24 0  0  0   0   1 4 0  0  0  0  0  0  
      Residual                9   12 24 0  0  0   0   1 4 0  0  0  0  0  0  
   Within Row.SquCCW.Col.Hal  72  0  0  0  0  0   0   1 4 0  0  0  0  0  0  
Between Oc:In:St:Ju:Pos                                                     
   Between Row:SquCCW:Col:Hal                                               
      Met                     1   12 0  0  0  0   0   1 0 0  0  0  0  0  0  
      Tre*Met                 3   12 0  0  0  0   0   1 0 0  0  0  0  0  0  
      Residual                20  12 0  0  0  0   0   1 0 0  0  0  0  0  0  
   Within Row.SquCCW.Col.Hal  408 0  0  0  0  0   0   1 0 0  0  0  0  0  0  

$ANOVA$Legend
 [1] "a = Row:SquCCW:Col:Hal" "b = Row*(SquCCW:Col)"   "c = Row*SquCCW"        
 [4] "d = SquCCW:Col"         "e = SquCCW"             "f = Row"               
 [7] "g = Oc:In:St:Ju:Pos"    "h = (Oc:In:St)*Ju"      "i = (Oc:In)*Ju"        
[10] "j = Oc*Ju"              "k = Ju"                 "l = Oc:In:St"          
[13] "m = Oc:In"              "n = Oc"                


$EF
$EF$trt
                              a    b   c  d    e f
Between Oc                                        
   Between SquCCW                                 
Between Oc:In                                     
Between Oc:In:St                                  
   Between SquCCW:Col                             
      Tre                     16/3        1/27    
   Within Row.SquCCW.Col.Hal                      
Between Ju                                        
Between Oc*Ju                                     
Between (Oc:In)*Ju                                
   Between Row                                    
   Between Row*SquCCW                             
   Within Row.SquCCW.Col.Hal                      
Between (Oc:In:St)*Ju                             
   Between SquCCW:Col                             
      Tre                     32/3        2/27    
   Between Row*(SquCCW:Col)                       
      Tre                     128         8/9     
   Within Row.SquCCW.Col.Hal                      
Between Oc:In:St:Ju:Pos                           
   Between Row:SquCCW:Col:Hal                     
      Met                          288         1  
      Tre*Met                          72        1
   Within Row.SquCCW.Col.Hal                      

$EF$Legend
[1] "a = Tre"         "b = Met"         "c = Tre*Met"     "d = eff.Tre"    
[5] "e = eff.Met"     "f = eff.Tre*Met"
\end{CodeOutput}
\end{CodeChunk}
Three additional features, which were not discussed in Section~\ref{sec:exampleTwoPase}, can be observed from this output. Since the Occasion factor of the Phase 2 experiment is completely confounded with Square factor of the Phase 1 experiment, the function will first output, \code{Note: Complete confounding between Squ and Oc!}, then the \code{Squ} is changed to \code{SquCCW}. The \code{CCW} stands for "completely confounded with". Furthermore, since \code{:} and \code{*} are used to denote the nesting and crossing between the treatment or block factors in the names in sources of variation and variance component, the parentheses in the structure formula are integrated into these names to further clarify the relationship between the treatment or block factors. Lastly, the lowermost stratum or the Within stratum always denote by all block factors, from either Phase 1 or Phase 2 experiment, concatenated with dots. 


\section[Conclusion]{Conclusion}
\pkg{InfoDecompuTE}, a freely available \proglang{R} package, allows researchers to study any complex single or two-phase experimental design by generating the structure of the theoretical ANOVA table with the coefficients of variance components of the EMS as shown in Section~\ref{sec:example}. This package not only allow the researchers to check for valid statistical test can be conducted, it also allows them to study how the raw data is decomposed across different strata and different sources of variation.

This package can also analyse non-orthogonal designs and produce the average efficiency factors for each fixed effect as shown in Section~\ref{sec:example}. Hence, the researcher will know the amount of the treatment information remains when conducting the test for the treatment effects. In addition, the users can also fit the each treatment contrast separately allowing more flexibility in the analysis and really dissect how the treatment information is split across different strata as shown in Section~\ref{sec:package}.

However, this package still has some limitations. Currently it can only analyse the single and two-phase experiments. If another phase was added, it would increase the computation time from $n^2$ to $n^3$. This is due to an additional for-loop being required to define the block structure of the additional phase. The best solution would be to re-implement the matrix calculation in another programming language such as \proglang{C} to speed up the computation time.

In addition, users need to have some understanding on how to build the model using the structure formulae for block and treatment structures of the two-phase experiments. Nonetheless, \pkg{infoDecompuTE} gives statistical researchers an additional tool for better understanding experimental designs and ability for constructing better experiments.

\section*{Acknowledgement}
Peter Tsai, Vicky Fan, Emma Marks, Steven Wu and Chew-Seng Chee for proofreading.

\bibliography{Reference/ref}

\end{document}
